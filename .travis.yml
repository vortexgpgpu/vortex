language: cpp
compiler: gcc

dist: focal
addons:
    apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - build-essential
        - valgrind
        - autoconf
        - automake
        - autotools-dev
        - lcov
        - bison
        - flex
        - texinfo
        - verilator
        - yosys
        
install:
  # RISCV_TOOLCHAIN
  - export RISCV_TOOLCHAIN_PATH=/opt/riscv-gnu-toolchain
  - sudo apt-get -y install \
      binutils build-essential libtool texinfo \
      gzip zip unzip patchutils curl git \
      make cmake ninja-build automake bison flex gperf \
      grep sed gawk python bc \
      zlib1g-dev libexpat1-dev libmpc-dev \
      libglib2.0-dev libfdt-dev libpixman-1-dev 
  - git clone https://github.com/riscv/riscv-gnu-toolchain
  - cd riscv-gnu-toolchain
  - git submodule update --init --recursive
  - mkdir build
  - cd build    
  - ../configure --prefix=$RISCV_TOOLCHAIN_PATH --with-arch=rv32im --with-abi=ilp32
  - make -j`nproc`  
  - make -j`nproc` build-qemu
  
  # VORTEX
  - git clone --recursive https://github.com/vortexgpgpu/vortex.git
  - cd Vortex
  - make
  - make -C /Vortex/benchmarks/opencl/sgemm
  - make -C /Vortex/benchmarks/opencl/sgemm run

script: 
  - ci/regression.sh ..
  
after_success:
  # Gather code coverage
  - lcov --directory . --capture --output-file coverage.info # capture trace  
  - lcov --list coverage.info # trace report
  # Upload coverage report
  - bash <(curl -s https://codecov.io/bash)
